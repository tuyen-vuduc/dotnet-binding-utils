name: Publish Android Library
run-name: ${{ inputs.LIB_FOLDER }} ðŸš€ NuGet
on:
  workflow_dispatch:
    inputs:
      LIB_FOLDER:
        description: 'Folder of Android library to publish'
        required: true
        type: choice
        options: 
        - com.braintreepayments.api--drop-in
        - com.intellimec.mobile.android--tripdetectionumbrella
        - com.izettle.payments--android-sdk-ui
        - com.mapbox.maps--android
        - org.jfrog.cardinalcommerce.gradle--cardinalmobilesdk
        - com.github.nguyenhoanglam--imagepicker
        - androidx.health.connect--connect-client
        - com.google.ar--core
        - org.jetbrains.kotlin
        - com.google.android.filament
        - com.github.kittinunf.result
        - com.github.kittinunf.fuel
        - dev.romainguy--kotlin-math
        - io.github.sceneview--sceneview
jobs:
  build-then-publish:
    environment: production
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set default Xamarin SDK versions
      run: |
        $VM_ASSETS/select-xamarin-sdk-v2.sh --mono=6.12 --android=13.0

    - name: Setup .NET Core SDK 7.0.101
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.101'

    - name: Setup Java 11
      uses: actions/setup-java@v3
      with:
        distribution: 'microsoft'
        java-version: '11'

    - name: Set MAPBOX_DOWNLOADS_TOKEN
      run: |
        echo "MAPBOX_DOWNLOADS_TOKEN=$MAPBOX_DOWNLOADS_TOKEN" >> ~/.gradle/gradle.properties
        cat ~/.gradle/gradle.properties
      shell: bash
      env:
        MAPBOX_DOWNLOADS_TOKEN : ${{secrets.MAPBOX_DOWNLOADS_TOKEN}}

    - name: Install android workload
      run: |
        dotnet workload install android

    - name: Build
      run: |
        cd "qs/${{ inputs.LIB_FOLDER }}"
        echo "PWD: $PWD"
        sh build.sh --base-path=$PWD
  
    # - name: Publish with Dotnet CLI
    #   env:
    #     NUGET_PUSH_API_KEY: ${{ secrets.NUGET_PUSH_API_KEY }}
    #   shell: bash
    #   run: |
    #     dotnet nuget push ./nugets/*.nupkg --api-key "$NUGET_PUSH_API_KEY" --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Publish NuGet and symbols
      id: nuget-push
      uses: edumserrano/nuget-push@v1.2.0
      with:
        api-key: '${{ secrets.NUGET_PUSH_API_KEY }}' # this example is using GitHub secrets to pass the API key
        working-directory: 'qs/${{ inputs.LIB_FOLDER }}/nugets'
    # The next step is using powershell to parse the action's output but you can use whatever you prefer.
    # Note that in order to read the step outputs the action step must have an id.
    - name: Log output
      if: steps.nuget-push.conclusion != 'skipped' && always() # run regardless if the previous step failed or not, just as long as it wasn't skipped
      shell: pwsh
      run: |
        $pushResult = '${{ steps.nuget-push.outputs.push-result }}' | ConvertFrom-Json
        $pushResultAsJsonIndented = ConvertTo-Json $pushResult
        Write-Output $pushResultAsJsonIndented  # outputs the result of the nuget push operation as an indented JSON string
        Write-Output '${{ steps.nuget-push.outputs.status }}' # outputs the overall status of the nuget push action

        # iterates over all list of packages and outputs the data from the nuget push operation for each
        foreach($package in $pushResult.packages) {
            Write-Output "$($package.status)"  # outputs the status of the nuget push operation
            Write-Output "$($package.package)" # outputs the NuGet package name that was pushed
            Write-Output "$($package.symbols)" # outputs the symbols package name that was pushed
        }
